<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Mart</title>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="76x76" href="assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="assets/favicon/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <!-- Fonts -->
    <link rel="stylesheet" href="./assets/fonts/stylesheet.css">

    <!-- Styles -->
    <link rel="stylesheet" href="./assets/css/main.css">

    <!-- Scripts -->
    <script src="./assets/js/scripts.js"></script>
</head>

<body>
    <!-- Header -->
    <header id="header" class="header"></header>
    <script>
        load("#header", "./templates/header.html");
    </script>

    <div class="container home">
        <div class="home__container">
            <!-- Slideshow -->
            <div class="slideshow">
                <div class="slideshow__inner">
                    <div class="slideshow__item">
                        <picture>
                            <source media="(max-width: 767.98px)" srcset="
                                        ./assets/img/slideshow/item-1-md.png
                                    ">
                            <img src="./assets/img/slideshow/item-1.png" alt="" class="slideshow__img">
                        </picture>
                    </div>
                </div>

                <div class="slideshow__page">
                    <span class="slideshow__slider"></span>
                </div>
            </div>
        </div>

        <!-- Top Product -->
        <div class="home__container">
            <div class="home__row">
                <div class="home__heading">Top Product</div>
            </div>
            <div class="home__cate row row-cols-3 row-cols-md-1">
                <!-- Category item 1 -->
                <div class="col">
                    <a href="#!">
                        <article class="cate-item">
                            <img src="./assets/img/category-item/item-1.png" alt="" class="cate-item__thumb">
                            <div class="cate-item__info">
                                <h3 class="cate-item__title">$24 - $150</h3>
                                <p class="cate-item__desc">
                                    New sumatra mandeling coffe blend
                                </p>
                            </div>
                        </article>
                    </a>
                </div>
            </div>
        </div>

        <!-- Product -->
        <section class="home__container">
            <div class="home__row">
                <h2 class="home__heading">Product</h2>
                <div id="filter"></div>
                <script>
                    load("#filter", "./templates/filter.html");
                </script>
            </div>
            <div id="productList" class="row row-cols-5 row-cols-lg-2 row-cols-sm-1 g-3">
            </div>

            <!-- Button: see more -->
            <button id="loadMore" class="load-more-btn btn btn--primary">See more</button>
        </section>
    </div>

    <!-- Footer -->
    <footer id="footer" class="footer"></footer>
    <script>
        fetchProducts();
        async function fetchProducts() {
            try {
                const response = await fetch('https://be-dacnpm.onrender.com/products');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const products = await response.json();
                displayTopRatedProducts(products);
                displayProducts(products);
            } catch (error) {
                console.log('Fetch error: ' + error.message);
            }
        }

        function displayTopRatedProducts(products) {
            // Sắp xếp sản phẩm theo rating từ cao xuống thấp
            const sortedProducts = products.sort((a, b) => b.ranking - a.ranking);
            // Lấy ra 3 sản phẩm có rating cao nhất
            const topRatedProducts = sortedProducts.slice(0, 3);

            const categoryListElement = document.querySelector('.home__cate.row');
            categoryListElement.innerHTML = ''; // Clear current categories

            topRatedProducts.forEach(product => {
                const categoryItemHTML = `
            <div class="col">
                <a href="./product-detail.html">
                    <article class="cate-item">
                        <img src="${product.image_src}" alt="" class="cate-item__thumb">
                        <div class="cate-item__info">
                            <h3 class="cate-item__title">$${product.price}</h3>
                            <p class="cate-item__desc">
                                ${product.name}
                            </p>
                        </div>
                    </article>
                </a>
            </div>
        `;
                categoryListElement.innerHTML += categoryItemHTML;
            });
        }

        // Xử lý hiển thị tối đa 15 sản phẩm 1 lần
        let currentProductIndex = 0; // Lưu trữ chỉ số của sản phẩm cuối cùng được hiển thị
        const productsPerPage = 15; // Số lượng sản phẩm được hiển thị mỗi lần

        // Hàm hiển thị sản phẩm với giới hạn và hỗ trợ tải thêm
        function displayProducts(products, reset = false) {
            const productListElement = document.getElementById('productList');
            if (reset) {
                productListElement.innerHTML = ''; // Nếu reset là true, xóa danh sách sản phẩm hiện tại
                currentProductIndex = 0;
            }

            // Tính toán số lượng sản phẩm còn lại có thể hiển thị
            const remainingProducts = products.length - currentProductIndex;
            const count = Math.min(productsPerPage, remainingProducts);

            for (let i = 0; i < count; i++) {
                const product = products[currentProductIndex + i];
                const productHTML = `
            <div class="col">
                <article class="product-card">
                            <div class="product-card__img-wrap">
                                <a href="./product-detail.html">
                                    <img src="${product.image_src}" alt="" class="product-card__thumb">
                                </a>
                                <button class="like-btn product-card__like-btn">
                                    <img src="./assets/icons/heart.svg" alt="" class="like-btn__icon icon">
                                    <img src="./assets/icons/heart-red.svg" alt="" class="like-btn__icon--liked">
                                </button>
                            </div>
                            <h3 class="product-card__title">
                                <a href="./product-detail.html">${product.name}</a>
                            </h3>
                            <div class="product-card__row">
                                <span class="product-card__price">$${product.price}</span>
                                <img src="./assets/icons/star.svg" alt="" class="product-card__star">
                                <span class="product-card__score">${product.ranking}</span>
                            </div>
                        </article>
            </div>
        `;
                productListElement.innerHTML += productHTML;
            }
            currentProductIndex += count; // Cập nhật chỉ số sản phẩm cuối cùng được hiển thị

            // Ẩn nút Xem thêm nếu đã hiển thị tất cả sản phẩm
            if (currentProductIndex >= products.length) {
                document.getElementById('loadMore').style.display = 'none';
            } else {
                document.getElementById('loadMore').style.display = 'inline-block';
            }
            attachLikeEventListeners(); // Gắn lại sự kiện cho nút like
        }

        // Hàm xử lý khi nhấn nút Xem thêm
        function loadMoreProducts() {
            fetchProducts(); // Gọi lại hàm fetchProducts() hoặc chỉ đơn giản là displayProducts(products) với danh sách sản phẩm hiện có.
        }

        document.getElementById('loadMore').addEventListener('click', loadMoreProducts);

        function attachLikeEventListeners() {
            var likeButtons = document.querySelectorAll(".like-btn.product-card__like-btn");
            likeButtons.forEach(function (button) {
                button.addEventListener("click", function (event) {
                    event.preventDefault();
                    this.classList.toggle("like-btn--liked");
                });
            });
        }
    </script>

    <script>
        load("#footer", "./templates/footer.html");
    </script>

</body>

</html>